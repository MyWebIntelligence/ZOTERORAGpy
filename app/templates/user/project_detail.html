{% extends "base.html" %}

{% block title %}{{ project.name }} - RAGpy{% endblock %}

{% set show_sidebar = true %}

{% block content %}
<div class="page-container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav">
        <a href="/" class="breadcrumb-link">Accueil</a>
        <i class="bi bi-chevron-right breadcrumb-sep"></i>
        <a href="/projects" class="breadcrumb-link">Mes projets</a>
        <i class="bi bi-chevron-right breadcrumb-sep"></i>
        <span class="breadcrumb-current">{{ project.name }}</span>
    </nav>

    <!-- Page Header -->
    <div class="page-header-flex">
        <div class="page-header-content">
            <h1 class="page-title">{{ project.name }}</h1>
            {% if project.description %}
            <p class="page-subtitle">{{ project.description }}</p>
            {% endif %}
        </div>
        <div class="page-header-actions">
            <span class="badge badge-secondary badge-lg">{{ user_role }}</span>
        </div>
    </div>

    <!-- Info Grid -->
    <div class="info-grid">
        <!-- Project Info Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="bi bi-info-circle"></i>
                    Informations
                </h2>
            </div>
            <div class="card-body">
                <div class="info-list">
                    <div class="info-item">
                        <span class="info-label">Proprietaire</span>
                        <span class="info-value">{{ owner.full_name if owner else 'Inconnu' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cree le</span>
                        <span class="info-value">{{ project.created_at.strftime('%d/%m/%Y') if project.created_at else '-' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Dossier de session</span>
                        <span class="info-value">
                            <code>{{ project.session_folder or 'Non defini' }}</code>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Base vectorielle</span>
                        <span class="info-value">{{ project.vector_db_type or 'Non configuree' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="bi bi-gear"></i>
                    Actions
                </h2>
            </div>
            <div class="card-body">
                <div class="actions-stack">
                    <a href="/?project={{ project.id }}" class="btn btn-primary btn-full">
                        <i class="bi bi-play-circle"></i>
                        Lancer un pipeline
                    </a>
                    {% if user_role == 'owner' or current_user.is_admin %}
                    <button class="btn btn-secondary btn-full" onclick="openModal('editProjectModal')">
                        <i class="bi bi-pencil"></i>
                        Modifier le projet
                    </button>
                    <button class="btn btn-danger btn-full" onclick="openModal('deleteModal')">
                        <i class="bi bi-trash"></i>
                        Supprimer le projet
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Sessions -->
    <div class="section">
        <div class="section-header-flex">
            <h2 class="section-title">
                <i class="bi bi-diagram-3"></i>
                Sessions de pipeline
            </h2>
            <a href="/?project={{ project.id }}" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-lg"></i>
                Nouvelle session
            </a>
        </div>
        <div class="card">
            <div class="card-body" id="sessionsList">
                <div class="loading-placeholder">
                    <span class="spinner"></span>
                    <span>Chargement des sessions...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Members -->
    <div class="section">
        <div class="section-header-flex">
            <h2 class="section-title">
                <i class="bi bi-people"></i>
                Membres du projet
            </h2>
            {% if user_role == 'owner' or current_user.is_admin %}
            <button class="btn btn-primary btn-sm" onclick="openModal('addMemberModal')">
                <i class="bi bi-plus-lg"></i>
                Ajouter
            </button>
            {% endif %}
        </div>
        <div class="card">
            <div class="card-body" id="membersList">
                <div class="loading-placeholder">
                    <span class="spinner"></span>
                    <span>Chargement des membres...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal" id="editProjectModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Modifier le projet</h3>
            <button class="modal-close" onclick="closeModal('editProjectModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editProjectForm">
                <div class="form-group">
                    <label for="editProjectName" class="form-label">Nom du projet</label>
                    <input type="text" class="form-input" id="editProjectName" value="{{ project.name }}" required>
                </div>
                <div class="form-group">
                    <label for="editProjectDescription" class="form-label">Description</label>
                    <textarea class="form-textarea" id="editProjectDescription" rows="3">{{ project.description or '' }}</textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('editProjectModal')">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="updateProject()">Enregistrer</button>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div class="modal" id="addMemberModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Ajouter un membre</h3>
            <button class="modal-close" onclick="closeModal('addMemberModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="addMemberForm">
                <div class="form-group">
                    <label for="memberEmail" class="form-label">Email de l'utilisateur</label>
                    <input type="email" class="form-input" id="memberEmail" required placeholder="utilisateur@email.com">
                </div>
                <div class="form-group">
                    <label for="memberRole" class="form-label">Role</label>
                    <select class="form-select" id="memberRole">
                        <option value="viewer">Lecteur</option>
                        <option value="collaborator">Collaborateur</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addMemberModal')">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="addMember()">Ajouter</button>
        </div>
    </div>
</div>

<!-- Delete Project Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3 class="modal-title">Supprimer le projet</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-warning">
                <div class="delete-warning-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <p>Supprimer ce projet?</p>
                <p class="text-danger text-sm"><strong>Cette action est irreversible.</strong></p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Annuler</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">Supprimer</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-6);
    }

    /* Breadcrumb */
    .breadcrumb-nav {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-4);
        font-size: var(--font-size-sm);
    }

    .breadcrumb-link {
        color: var(--color-text-secondary);
        text-decoration: none;
    }

    .breadcrumb-link:hover {
        color: var(--color-brand-primary);
    }

    .breadcrumb-sep {
        color: var(--color-text-muted);
        font-size: var(--font-size-xs);
    }

    .breadcrumb-current {
        color: var(--color-text-primary);
        font-weight: var(--font-weight-medium);
    }

    /* Page Header */
    .page-header-flex {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--space-4);
        margin-bottom: var(--space-6);
    }

    .page-title {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-text-primary);
        margin-bottom: var(--space-2);
    }

    .page-subtitle {
        color: var(--color-text-secondary);
    }

    .badge-lg {
        padding: var(--space-2) var(--space-3);
        font-size: var(--font-size-sm);
    }

    /* Info Grid */
    .info-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--space-6);
        margin-bottom: var(--space-8);
    }

    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
        }
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-semibold);
        margin: 0;
    }

    .info-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: var(--space-3);
        border-bottom: 1px solid var(--color-border-light);
    }

    .info-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .info-label {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
    }

    .info-value {
        font-weight: var(--font-weight-medium);
        color: var(--color-text-primary);
    }

    .info-value code {
        font-size: var(--font-size-xs);
        background: var(--color-surface-hover);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
    }

    .actions-stack {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }

    .btn-full {
        width: 100%;
        justify-content: center;
    }

    /* Sections */
    .section {
        margin-bottom: var(--space-8);
    }

    .section-header-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        margin: 0;
    }

    .loading-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
        padding: var(--space-8);
        color: var(--color-text-secondary);
    }

    /* Modal */
    .modal-sm .modal-content {
        max-width: 400px;
    }

    .delete-warning {
        text-align: center;
        padding: var(--space-4) 0;
    }

    .delete-warning-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-4);
        background: var(--color-danger-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-danger);
        font-size: 1.75rem;
    }

    .text-sm {
        font-size: var(--font-size-sm);
    }

    /* Sessions & Members Table */
    .empty-state-small {
        text-align: center;
        padding: var(--space-8);
    }

    .empty-state-small-icon {
        font-size: 2.5rem;
        color: var(--color-text-muted);
        margin-bottom: var(--space-3);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
const projectId = {{ project.id }};

async function loadMembers() {
    try {
        const response = await fetch(`/projects/${projectId}/members`, {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const members = await response.json();
            renderMembers(members);
        }
    } catch (error) {
        console.error('Error loading members:', error);
    }
}

function renderMembers(members) {
    const container = document.getElementById('membersList');

    if (!members || members.length === 0) {
        container.innerHTML = `
            <div class="empty-state-small">
                <div class="empty-state-small-icon"><i class="bi bi-people"></i></div>
                <p class="text-muted">Aucun membre</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${members.map(m => `
                        <tr>
                            <td>${escapeHtml(m.full_name)}</td>
                            <td>${escapeHtml(m.email)}</td>
                            <td><span class="badge badge-secondary">${m.role}</span></td>
                            <td class="text-right">
                                ${m.role !== 'owner' ? `
                                    <button class="btn btn-ghost btn-sm" onclick="removeMember(${m.user_id})">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

async function updateProject() {
    const name = document.getElementById('editProjectName').value;
    const description = document.getElementById('editProjectDescription').value;

    try {
        const response = await fetch(`/projects/${projectId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            body: JSON.stringify({ name, description })
        });

        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la mise a jour', 'error');
    }
}

async function addMember() {
    const email = document.getElementById('memberEmail').value;
    const role = document.getElementById('memberRole').value;

    try {
        const response = await fetch(`/projects/${projectId}/members`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            body: JSON.stringify({ email, role })
        });

        if (response.ok) {
            closeModal('addMemberModal');
            document.getElementById('addMemberForm').reset();
            loadMembers();
            showToast('Membre ajoute', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de l\'ajout', 'error');
    }
}

async function removeMember(userId) {
    if (!confirm('Retirer ce membre du projet?')) return;

    try {
        const response = await fetch(`/projects/${projectId}/members/${userId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            loadMembers();
            showToast('Membre retire', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la suppression', 'error');
    }
}

async function confirmDelete() {
    try {
        const response = await fetch(`/projects/${projectId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            window.location.href = '/projects';
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la suppression', 'error');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Sessions Management
async function loadSessions() {
    try {
        const response = await fetch(`/api/pipeline/projects/${projectId}/sessions`, {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const data = await response.json();
            renderSessions(data.sessions);
        } else {
            document.getElementById('sessionsList').innerHTML = `
                <div class="empty-state-small">
                    <p class="text-muted">Impossible de charger les sessions</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading sessions:', error);
    }
}

function getStatusBadge(status) {
    const statusMap = {
        'created': { class: 'badge-secondary', label: 'Cree' },
        'extracting': { class: 'badge-info', label: 'Extraction...' },
        'extracted': { class: 'badge-primary', label: 'Extrait' },
        'chunking': { class: 'badge-info', label: 'Chunking...' },
        'chunked': { class: 'badge-primary', label: 'Chunke' },
        'embedding': { class: 'badge-info', label: 'Embeddings...' },
        'embedded': { class: 'badge-primary', label: 'Embeddings OK' },
        'uploading': { class: 'badge-info', label: 'Upload...' },
        'completed': { class: 'badge-success', label: 'Termine' },
        'error': { class: 'badge-danger', label: 'Erreur' }
    };
    const info = statusMap[status] || { class: 'badge-secondary', label: status };
    return `<span class="badge ${info.class}">${info.label}</span>`;
}

function renderSessions(sessions) {
    const container = document.getElementById('sessionsList');

    if (!sessions || sessions.length === 0) {
        container.innerHTML = `
            <div class="empty-state-small">
                <div class="empty-state-small-icon"><i class="bi bi-inbox"></i></div>
                <p class="text-muted">Aucune session de pipeline</p>
                <a href="/?project=${projectId}" class="btn btn-primary btn-sm">
                    <i class="bi bi-play-circle"></i>
                    Demarrer un pipeline
                </a>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Source</th>
                        <th>Statut</th>
                        <th>Documents</th>
                        <th>Date</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${sessions.map(s => `
                        <tr>
                            <td>
                                <code class="text-sm">${escapeHtml(s.session_folder)}</code>
                                ${s.original_filename ? `<br><small class="text-muted">${escapeHtml(s.original_filename)}</small>` : ''}
                            </td>
                            <td>
                                ${s.source_type === 'zip' ? '<i class="bi bi-file-zip text-warning"></i> ZIP' : ''}
                                ${s.source_type === 'csv' ? '<i class="bi bi-filetype-csv text-success"></i> CSV' : ''}
                            </td>
                            <td>${getStatusBadge(s.status)}</td>
                            <td>
                                ${s.row_count ? `<span class="badge badge-light">${s.row_count} docs</span>` : '-'}
                                ${s.chunk_count ? `<span class="badge badge-light">${s.chunk_count} chunks</span>` : ''}
                            </td>
                            <td><small>${formatDate(s.created_at)}</small></td>
                            <td class="text-right">
                                <a href="/?project=${projectId}&session=${encodeURIComponent(s.session_folder)}"
                                   class="btn btn-ghost btn-sm" title="Reprendre">
                                    <i class="bi bi-play-circle"></i>
                                </a>
                                <button class="btn btn-ghost btn-sm" onclick="deleteSession(${s.id})" title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('fr-FR', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
}

async function deleteSession(sessionId) {
    if (!confirm('Supprimer cette session et tous ses fichiers?')) return;

    try {
        const response = await fetch(`/api/pipeline/sessions/${sessionId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            loadSessions();
            showToast('Session supprimee', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la suppression', 'error');
    }
}

// Load data on page load
loadMembers();
loadSessions();
</script>
{% endblock %}
