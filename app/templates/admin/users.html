{% extends "base.html" %}

{% block title %}Utilisateurs - Administration - RAGpy{% endblock %}

{% set show_sidebar = true %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <h1 class="page-title">Utilisateurs</h1>
            <p class="page-subtitle">Gerer les comptes utilisateurs de la plateforme</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group filter-search">
            <div class="input-with-icon">
                <i class="bi bi-search input-icon"></i>
                <input type="text"
                       class="form-input"
                       id="searchInput"
                       placeholder="Rechercher un utilisateur...">
            </div>
        </div>
        <div class="filter-group">
            <select class="form-select" id="statusFilter">
                <option value="">Tous les statuts</option>
                <option value="active">Actifs</option>
                <option value="inactive">Inactifs</option>
            </select>
        </div>
        <div class="filter-group">
            <select class="form-select" id="roleFilter">
                <option value="">Tous les roles</option>
                <option value="admin">Administrateurs</option>
                <option value="user">Utilisateurs</option>
            </select>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Utilisateur</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Statut</th>
                        <th>Verifie</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="6">
                            <div class="table-loading">
                                <span class="spinner"></span>
                                <span>Chargement des utilisateurs...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" id="pagination">
        <div class="pagination"></div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal" id="resetPasswordModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Reinitialiser le mot de passe</h3>
            <button class="modal-close" onclick="closeModal('resetPasswordModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="resetTokenInitial">
                <p class="text-secondary">Un token de reinitialisation sera genere pour cet utilisateur.</p>
            </div>
            <div id="resetTokenResult" style="display: none;">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <div>
                        <strong>Token de reinitialisation:</strong>
                        <code id="resetTokenValue" class="token-display"></code>
                    </div>
                </div>
                <p class="text-muted text-sm">Ce token expire dans 24 heures.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Fermer</button>
            <button type="button" class="btn btn-primary" id="confirmResetBtn">
                <i class="bi bi-key"></i>
                Generer le token
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3 class="modal-title">Confirmer la suppression</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-warning">
                <div class="delete-warning-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <p>Etes-vous sur de vouloir supprimer cet utilisateur?</p>
                <p class="text-danger text-sm"><strong>Cette action est irreversible.</strong></p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Annuler</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                <i class="bi bi-trash"></i>
                Supprimer
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-6);
    }

    .page-header {
        margin-bottom: var(--space-6);
    }

    .page-title {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-text-primary);
        margin-bottom: var(--space-2);
    }

    .page-subtitle {
        font-size: var(--font-size-base);
        color: var(--color-text-secondary);
    }

    /* Filters */
    .filters-bar {
        display: flex;
        gap: var(--space-4);
        margin-bottom: var(--space-6);
        flex-wrap: wrap;
    }

    .filter-group {
        min-width: 180px;
    }

    .filter-search {
        flex: 1;
        min-width: 280px;
    }

    .input-with-icon {
        position: relative;
    }

    .input-icon {
        position: absolute;
        left: var(--space-3);
        top: 50%;
        transform: translateY(-50%);
        color: var(--color-text-muted);
        pointer-events: none;
    }

    .input-with-icon .form-input {
        padding-left: var(--space-10);
    }

    /* Table Styles */
    .table-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
        padding: var(--space-10);
        color: var(--color-text-secondary);
    }

    .table-empty {
        text-align: center;
        padding: var(--space-10) var(--space-4);
    }

    .table-empty-icon {
        font-size: 2.5rem;
        color: var(--color-text-muted);
        margin-bottom: var(--space-3);
    }

    .table-empty-text {
        color: var(--color-text-secondary);
    }

    /* User Cell */
    .user-cell {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--color-brand-bg);
        color: var(--color-brand-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-weight-medium);
        font-size: var(--font-size-sm);
        flex-shrink: 0;
    }

    .user-info {
        min-width: 0;
    }

    .user-name {
        font-weight: var(--font-weight-medium);
        color: var(--color-text-primary);
    }

    .user-id {
        font-size: var(--font-size-xs);
        color: var(--color-text-muted);
    }

    /* Actions */
    .actions-cell {
        display: flex;
        gap: var(--space-1);
        justify-content: flex-end;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: 1px solid transparent;
        border-radius: var(--radius-md);
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: var(--transition-fast);
    }

    .btn-icon:hover {
        background: var(--color-surface-hover);
        color: var(--color-text-primary);
    }

    .btn-icon-danger:hover {
        background: var(--color-danger-bg);
        color: var(--color-danger);
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: var(--space-6);
    }

    .pagination {
        display: flex;
        gap: var(--space-1);
    }

    .page-btn {
        min-width: 36px;
        height: 36px;
        padding: 0 var(--space-3);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        cursor: pointer;
        transition: var(--transition-fast);
    }

    .page-btn:hover:not(:disabled) {
        background: var(--color-surface-hover);
        border-color: var(--color-border-hover);
    }

    .page-btn.active {
        background: var(--color-brand-primary);
        border-color: var(--color-brand-primary);
        color: white;
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-ellipsis {
        min-width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text-muted);
    }

    /* Modal Styles */
    .modal-sm .modal-content {
        max-width: 400px;
    }

    .token-display {
        display: block;
        margin-top: var(--space-2);
        padding: var(--space-2) var(--space-3);
        background: var(--color-surface-hover);
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: var(--font-size-sm);
        word-break: break-all;
    }

    .delete-warning {
        text-align: center;
        padding: var(--space-4) 0;
    }

    .delete-warning-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-4);
        background: var(--color-danger-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-danger);
        font-size: 1.75rem;
    }

    .text-right {
        text-align: right;
    }

    .text-sm {
        font-size: var(--font-size-sm);
    }

    .text-secondary {
        color: var(--color-text-secondary);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentUserId = null;

async function loadUsers(page = 1) {
    const search = document.getElementById('searchInput').value;
    const status = document.getElementById('statusFilter').value;
    const role = document.getElementById('roleFilter').value;

    let url = `/admin/users?page=${page}&per_page=20`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (status === 'active') url += '&is_active=true';
    if (status === 'inactive') url += '&is_active=false';
    if (role === 'admin') url += '&is_admin=true';
    if (role === 'user') url += '&is_admin=false';

    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const data = await response.json();
            renderUsers(data.users);
            renderPagination(data.page, data.pages);
            currentPage = page;
        } else if (response.status === 401 || response.status === 403) {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Error loading users:', error);
        showToast('Erreur lors du chargement des utilisateurs', 'error');
    }
}

function renderUsers(users) {
    const tbody = document.getElementById('usersTableBody');

    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="table-empty">
                        <div class="table-empty-icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <p class="table-empty-text">Aucun utilisateur trouve</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = users.map(user => {
        const initials = getInitials(user.first_name, user.last_name, user.email);
        const displayName = [user.first_name, user.last_name].filter(Boolean).join(' ') || user.email.split('@')[0];

        return `
            <tr>
                <td>
                    <div class="user-cell">
                        <div class="user-avatar">${initials}</div>
                        <div class="user-info">
                            <div class="user-name">${displayName}</div>
                            <div class="user-id">ID: ${user.id}</div>
                        </div>
                    </div>
                </td>
                <td>${user.email}</td>
                <td>
                    ${user.roles.map(role => `
                        <span class="badge ${role === 'ADMIN' ? 'badge-primary' : 'badge-secondary'}">
                            ${role}
                        </span>
                    `).join(' ')}
                </td>
                <td>
                    <span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">
                        ${user.is_active ? 'Actif' : 'Inactif'}
                    </span>
                </td>
                <td>
                    ${user.is_verified
                        ? '<i class="bi bi-check-circle-fill text-success"></i>'
                        : '<i class="bi bi-x-circle text-muted"></i>'}
                </td>
                <td>
                    <div class="actions-cell">
                        <button class="btn-icon tooltip" data-tooltip="${user.is_active ? 'Desactiver' : 'Activer'}" onclick="toggleActive(${user.id})">
                            <i class="bi bi-${user.is_active ? 'lock' : 'unlock'}"></i>
                        </button>
                        <button class="btn-icon tooltip" data-tooltip="${user.is_admin ? 'Retirer admin' : 'Promouvoir admin'}" onclick="toggleAdmin(${user.id})">
                            <i class="bi bi-shield${user.is_admin ? '-fill' : ''}"></i>
                        </button>
                        <button class="btn-icon tooltip" data-tooltip="Reinitialiser mot de passe" onclick="showResetPassword(${user.id})">
                            <i class="bi bi-key"></i>
                        </button>
                        <button class="btn-icon btn-icon-danger tooltip" data-tooltip="Supprimer" onclick="showDeleteConfirm(${user.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function getInitials(firstName, lastName, email) {
    if (firstName && lastName) {
        return (firstName[0] + lastName[0]).toUpperCase();
    }
    if (firstName) {
        return firstName[0].toUpperCase();
    }
    return email[0].toUpperCase();
}

function renderPagination(currentPage, totalPages) {
    const pagination = document.querySelector('.pagination');

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';

    // Previous button
    html += `
        <button class="page-btn" onclick="loadUsers(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="bi bi-chevron-left"></i>
        </button>
    `;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadUsers(${i})">
                    ${i}
                </button>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<span class="page-ellipsis">...</span>';
        }
    }

    // Next button
    html += `
        <button class="page-btn" onclick="loadUsers(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="bi bi-chevron-right"></i>
        </button>
    `;

    pagination.innerHTML = html;
}

async function toggleActive(userId) {
    try {
        const response = await fetch(`/admin/users/${userId}/toggle-active`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            loadUsers(currentPage);
            showToast('Statut utilisateur modifie', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la modification', 'error');
    }
}

async function toggleAdmin(userId) {
    try {
        const response = await fetch(`/admin/users/${userId}/toggle-admin`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            loadUsers(currentPage);
            showToast('Role utilisateur modifie', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la modification', 'error');
    }
}

function showResetPassword(userId) {
    currentUserId = userId;
    document.getElementById('resetTokenResult').style.display = 'none';
    document.getElementById('resetTokenInitial').style.display = 'block';
    document.getElementById('confirmResetBtn').style.display = '';
    openModal('resetPasswordModal');
}

document.getElementById('confirmResetBtn').addEventListener('click', async function() {
    try {
        const response = await fetch(`/admin/users/${currentUserId}/reset-password`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('resetTokenValue').textContent = data.reset_token;
            document.getElementById('resetTokenResult').style.display = 'block';
            document.getElementById('resetTokenInitial').style.display = 'none';
            document.getElementById('confirmResetBtn').style.display = 'none';
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la reinitialisation', 'error');
    }
});

function showDeleteConfirm(userId) {
    currentUserId = userId;
    openModal('deleteModal');
}

document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    try {
        const response = await fetch(`/admin/users/${currentUserId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        closeModal('deleteModal');

        if (response.ok) {
            loadUsers(currentPage);
            showToast('Utilisateur supprime', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la suppression', 'error');
    }
});

// Event listeners for filters
document.getElementById('searchInput').addEventListener('input', debounce(() => loadUsers(1), 300));
document.getElementById('statusFilter').addEventListener('change', () => loadUsers(1));
document.getElementById('roleFilter').addEventListener('change', () => loadUsers(1));

// Load users on page load
loadUsers();
</script>
{% endblock %}
