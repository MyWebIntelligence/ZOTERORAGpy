{% extends "base.html" %}

{% block title %}Utilisateurs - Administration - MyDoc Intelligence{% endblock %}

{% set show_sidebar = true %}

{% block sidebar %}
<aside class="sidebar">
    <div class="sidebar-header">MyDoc Intelligence</div>
    <nav class="nav flex-column">
        <a class="nav-link" href="/admin">
            <i class="bi bi-speedometer2"></i> Tableau de bord
        </a>
        <a class="nav-link active" href="/admin/users">
            <i class="bi bi-people"></i> Utilisateurs
        </a>
        <a class="nav-link" href="/admin/projects">
            <i class="bi bi-folder"></i> Projets
        </a>
        <a class="nav-link" href="/admin/settings">
            <i class="bi bi-gear"></i> Param&egrave;tres
        </a>
    </nav>
</aside>
{% endblock %}

{% block content %}
<h1 class="mb-4">Liste des Utilisateurs</h1>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-md-4">
        <input type="text" class="form-control" id="searchInput" placeholder="Rechercher...">
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">Tous les statuts</option>
            <option value="active">Actifs</option>
            <option value="inactive">Inactifs</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="roleFilter">
            <option value="">Tous les r&ocirc;les</option>
            <option value="admin">Administrateurs</option>
            <option value="user">Utilisateurs</option>
        </select>
    </div>
</div>

<!-- Users table -->
<div class="table-container">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Pr&eacute;nom</th>
                <th>Nom</th>
                <th>Email</th>
                <th>R&ocirc;les</th>
                <th>Statut</th>
                <th>V&eacute;rifi&eacute;</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="usersTableBody">
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    Chargement...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<nav class="mt-4" id="pagination">
    <ul class="pagination justify-content-center">
    </ul>
</nav>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">R&eacute;initialiser le mot de passe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Un token de r&eacute;initialisation sera g&eacute;n&eacute;r&eacute; pour l'utilisateur.</p>
                <div id="resetTokenResult" class="d-none">
                    <div class="alert alert-info">
                        <strong>Token de r&eacute;initialisation:</strong>
                        <code id="resetTokenValue"></code>
                    </div>
                    <p class="text-muted small">Ce token expire dans 24 heures.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="confirmResetBtn">G&eacute;n&eacute;rer le token</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>&Ecirc;tes-vous s&ucirc;r de vouloir supprimer cet utilisateur ?</p>
                <p class="text-danger"><strong>Cette action est irr&eacute;versible.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentUserId = null;

async function loadUsers(page = 1) {
    const search = document.getElementById('searchInput').value;
    const status = document.getElementById('statusFilter').value;
    const role = document.getElementById('roleFilter').value;

    let url = `/admin/users?page=${page}&per_page=20`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (status === 'active') url += '&is_active=true';
    if (status === 'inactive') url += '&is_active=false';
    if (role === 'admin') url += '&is_admin=true';
    if (role === 'user') url += '&is_admin=false';

    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const data = await response.json();
            renderUsers(data.users);
            renderPagination(data.page, data.pages);
            currentPage = page;
        } else if (response.status === 401 || response.status === 403) {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

function renderUsers(users) {
    const tbody = document.getElementById('usersTableBody');

    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    Aucun utilisateur trouv&eacute;
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.id}</td>
            <td>${user.first_name || '-'}</td>
            <td>${user.last_name || '-'}</td>
            <td>${user.email}</td>
            <td>
                ${user.roles.map(role => `
                    <span class="badge badge-role ${role === 'ADMIN' ? 'badge-admin' : 'badge-user'}">
                        ${role}
                    </span>
                `).join(' ')}
            </td>
            <td>
                <span class="badge ${user.is_active ? 'badge-active' : 'badge-inactive'}">
                    ${user.is_active ? 'Actif' : 'Inactif'}
                </span>
            </td>
            <td>${user.is_verified ? 'Oui' : 'Non'}</td>
            <td>
                <div class="d-flex gap-1">
                    <button class="btn-action btn-lock" onclick="toggleActive(${user.id})" title="${user.is_active ? 'D\u00e9sactiver' : 'Activer'}">
                        <i class="bi bi-${user.is_active ? 'lock' : 'unlock'}"></i>
                    </button>
                    <button class="btn-action btn-shield" onclick="toggleAdmin(${user.id})" title="${user.is_admin ? 'Retirer admin' : 'Promouvoir admin'}">
                        <i class="bi bi-shield${user.is_admin ? '-fill' : ''}"></i>
                    </button>
                    <button class="btn-action btn-key" onclick="showResetPassword(${user.id})" title="R\u00e9initialiser le mot de passe">
                        <i class="bi bi-key"></i>
                    </button>
                    <button class="btn-action btn-delete" onclick="showDeleteConfirm(${user.id})" title="Supprimer">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function renderPagination(currentPage, totalPages) {
    const pagination = document.querySelector('#pagination .pagination');

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';

    // Previous
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadUsers(${currentPage - 1}); return false;">Pr&eacute;c&eacute;dent</a>
        </li>
    `;

    // Pages
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadUsers(${i}); return false;">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    // Next
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadUsers(${currentPage + 1}); return false;">Suivant</a>
        </li>
    `;

    pagination.innerHTML = html;
}

async function toggleActive(userId) {
    try {
        const response = await fetch(`/admin/users/${userId}/toggle-active`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            loadUsers(currentPage);
            showFlash('Statut utilisateur modifi&eacute;', 'success');
        } else {
            const data = await response.json();
            showFlash(data.detail || 'Erreur', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showFlash('Erreur lors de la modification', 'danger');
    }
}

async function toggleAdmin(userId) {
    try {
        const response = await fetch(`/admin/users/${userId}/toggle-admin`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            loadUsers(currentPage);
            showFlash('R&ocirc;le utilisateur modifi&eacute;', 'success');
        } else {
            const data = await response.json();
            showFlash(data.detail || 'Erreur', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showFlash('Erreur lors de la modification', 'danger');
    }
}

function showResetPassword(userId) {
    currentUserId = userId;
    document.getElementById('resetTokenResult').classList.add('d-none');
    document.getElementById('confirmResetBtn').classList.remove('d-none');
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

document.getElementById('confirmResetBtn').addEventListener('click', async function() {
    try {
        const response = await fetch(`/admin/users/${currentUserId}/reset-password`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('resetTokenValue').textContent = data.reset_token;
            document.getElementById('resetTokenResult').classList.remove('d-none');
            document.getElementById('confirmResetBtn').classList.add('d-none');
        } else {
            const data = await response.json();
            showFlash(data.detail || 'Erreur', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showFlash('Erreur lors de la r&eacute;initialisation', 'danger');
    }
});

function showDeleteConfirm(userId) {
    currentUserId = userId;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    try {
        const response = await fetch(`/admin/users/${currentUserId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();

        if (response.ok) {
            loadUsers(currentPage);
            showFlash('Utilisateur supprim&eacute;', 'success');
        } else {
            const data = await response.json();
            showFlash(data.detail || 'Erreur', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showFlash('Erreur lors de la suppression', 'danger');
    }
});

// Event listeners for filters
document.getElementById('searchInput').addEventListener('input', debounce(() => loadUsers(1), 300));
document.getElementById('statusFilter').addEventListener('change', () => loadUsers(1));
document.getElementById('roleFilter').addEventListener('change', () => loadUsers(1));

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Load users on page load
loadUsers();
</script>
{% endblock %}
