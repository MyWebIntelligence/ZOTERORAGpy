{% extends "base.html" %}

{% block title %}Utilisateurs - Administration - RAGpy{% endblock %}

{% set show_sidebar = true %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <h1 class="page-title">Gestion des utilisateurs</h1>
            <p class="page-subtitle">Gerez les comptes utilisateurs de la plateforme</p>
        </div>
    </div>

    <!-- Section Administrateurs -->
    <div class="users-section">
        <div class="section-header-with-badge">
            <h2 class="section-title">
                <i class="bi bi-shield-check"></i>
                Administrateurs
            </h2>
            <span class="section-count" id="adminCount">0</span>
        </div>
        <div class="card">
            <div class="table-container">
                <table class="table table-compact">
                    <thead>
                        <tr>
                            <th class="col-id">ID</th>
                            <th>Prenom</th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Statut</th>
                            <th class="col-verified">Email</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody">
                        <tr>
                            <td colspan="8">
                                <div class="table-loading">
                                    <span class="spinner"></span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Section Utilisateurs -->
    <div class="users-section">
        <div class="section-header-with-badge">
            <h2 class="section-title">
                <i class="bi bi-people"></i>
                Utilisateurs
            </h2>
            <span class="section-count" id="userCount">0</span>
        </div>
        <div class="card">
            <div class="table-container">
                <table class="table table-compact">
                    <thead>
                        <tr>
                            <th class="col-id">ID</th>
                            <th>Prenom</th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Statut</th>
                            <th class="col-verified">Email</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="8">
                                <div class="table-loading">
                                    <span class="spinner"></span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Section Bloques -->
    <div class="users-section">
        <div class="section-header-with-badge">
            <h2 class="section-title">
                <i class="bi bi-slash-circle"></i>
                Bloques
            </h2>
            <span class="section-count section-count-danger" id="blockedCount">0</span>
        </div>
        <div class="card">
            <div class="table-container">
                <table class="table table-compact">
                    <thead>
                        <tr>
                            <th class="col-id">ID</th>
                            <th>Prenom</th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Statut</th>
                            <th class="col-verified">Email</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="blockedTableBody">
                        <tr>
                            <td colspan="8">
                                <div class="table-loading">
                                    <span class="spinner"></span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal" id="resetPasswordModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Reinitialiser le mot de passe</h3>
            <button class="modal-close" onclick="closeModal('resetPasswordModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="resetTokenInitial">
                <p class="text-secondary">Un token de reinitialisation sera genere pour cet utilisateur.</p>
            </div>
            <div id="resetTokenResult" style="display: none;">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <div>
                        <strong>Token de reinitialisation:</strong>
                        <code id="resetTokenValue" class="token-display"></code>
                    </div>
                </div>
                <p class="text-muted text-sm">Ce token expire dans 24 heures.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Fermer</button>
            <button type="button" class="btn btn-primary" id="confirmResetBtn">
                <i class="bi bi-key"></i>
                Generer le token
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3 class="modal-title">Confirmer la suppression</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-warning">
                <div class="delete-warning-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <p>Etes-vous sur de vouloir supprimer cet utilisateur?</p>
                <p class="text-danger text-sm"><strong>Cette action est irreversible.</strong></p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Annuler</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                <i class="bi bi-trash"></i>
                Supprimer
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--space-6);
    }

    .page-header {
        margin-bottom: var(--space-8);
    }

    .page-title {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-text-primary);
        margin-bottom: var(--space-2);
    }

    .page-subtitle {
        font-size: var(--font-size-base);
        color: var(--color-text-secondary);
    }

    /* Sections */
    .users-section {
        margin-bottom: var(--space-8);
    }

    .section-header-with-badge {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        margin: 0;
    }

    .section-title i {
        color: var(--color-text-muted);
    }

    .section-count {
        background: var(--color-brand-bg);
        color: var(--color-brand-primary);
        padding: 2px 10px;
        border-radius: var(--radius-full);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
    }

    .section-count-danger {
        background: var(--color-danger-bg);
        color: var(--color-danger);
    }

    /* Table Columns */
    .col-id {
        width: 60px;
        text-align: center;
    }

    .col-verified {
        width: 70px;
        text-align: center;
    }

    .col-actions {
        width: 150px;
        text-align: center;
    }

    /* Table Compact */
    .table-compact td,
    .table-compact th {
        padding: var(--space-2) var(--space-3);
        font-size: var(--font-size-sm);
    }

    .table-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-6);
    }

    .table-empty {
        text-align: center;
        padding: var(--space-6);
        color: var(--color-text-muted);
    }

    .table-empty i {
        font-size: 1.5rem;
        margin-bottom: var(--space-2);
        display: block;
    }

    /* User Data Cells */
    .user-id {
        font-family: var(--font-family-mono);
        font-size: var(--font-size-xs);
        color: var(--color-text-muted);
        text-align: center;
    }

    .user-firstname,
    .user-lastname {
        font-weight: var(--font-weight-medium);
        color: var(--color-text-primary);
    }

    .user-email {
        color: var(--color-text-secondary);
    }

    .cell-na {
        color: var(--color-text-muted);
        font-style: italic;
    }

    /* Verified Icon */
    .verified-icon {
        font-size: 1rem;
    }

    .verified-yes {
        color: var(--color-success);
    }

    .verified-no {
        color: var(--color-text-muted);
    }

    /* Actions Cell */
    .actions-cell {
        display: flex;
        gap: var(--space-1);
        justify-content: center;
    }

    .btn-action {
        width: 30px;
        height: 30px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: var(--transition-fast);
        font-size: 0.875rem;
    }

    .btn-action:hover {
        background: var(--color-surface-hover);
        border-color: var(--color-border-hover);
    }

    /* Action Button Variants */
    .btn-action-block:hover {
        background: var(--color-danger-bg);
        border-color: var(--color-danger);
        color: var(--color-danger);
    }

    .btn-action-unblock:hover {
        background: var(--color-success-bg);
        border-color: var(--color-success);
        color: var(--color-success);
    }

    .btn-action-admin:hover {
        background: var(--color-brand-bg);
        border-color: var(--color-brand-primary);
        color: var(--color-brand-primary);
    }

    .btn-action-password:hover {
        background: var(--color-warning-bg);
        border-color: var(--color-warning);
        color: var(--color-warning);
    }

    .btn-action-delete:hover {
        background: var(--color-danger-bg);
        border-color: var(--color-danger);
        color: var(--color-danger);
    }

    /* Modal Styles */
    .modal-sm .modal-content {
        max-width: 400px;
    }

    .token-display {
        display: block;
        margin-top: var(--space-2);
        padding: var(--space-2) var(--space-3);
        background: var(--color-surface-hover);
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: var(--font-size-sm);
        word-break: break-all;
    }

    .delete-warning {
        text-align: center;
        padding: var(--space-4) 0;
    }

    .delete-warning-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-4);
        background: var(--color-danger-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-danger);
        font-size: 1.75rem;
    }

    .text-sm {
        font-size: var(--font-size-sm);
    }

    .text-secondary {
        color: var(--color-text-secondary);
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .table-container {
            overflow-x: auto;
        }

        .table-compact {
            min-width: 800px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentUserId = null;
let allUsers = [];

async function loadAllUsers() {
    try {
        // Charger tous les utilisateurs (max 100)
        const response = await fetch('/api/admin/users?per_page=100', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const data = await response.json();
            allUsers = data.users;
            categorizeAndRender();
        } else if (response.status === 401 || response.status === 403) {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Error loading users:', error);
        showToast('Erreur lors du chargement des utilisateurs', 'error');
    }
}

function categorizeAndRender() {
    // Categoriser les utilisateurs
    const admins = allUsers.filter(u => u.is_admin && u.is_active);
    const users = allUsers.filter(u => !u.is_admin && u.is_active);
    const blocked = allUsers.filter(u => !u.is_active);

    // Mettre a jour les compteurs
    document.getElementById('adminCount').textContent = admins.length;
    document.getElementById('userCount').textContent = users.length;
    document.getElementById('blockedCount').textContent = blocked.length;

    // Rendre les tableaux
    renderTable('adminTableBody', admins, 'Aucun administrateur');
    renderTable('userTableBody', users, 'Aucun utilisateur actif');
    renderTable('blockedTableBody', blocked, 'Aucun utilisateur bloque');
}

function renderTable(tableId, users, emptyMessage) {
    const tbody = document.getElementById(tableId);

    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8">
                    <div class="table-empty">
                        <i class="bi bi-inbox"></i>
                        <p>${emptyMessage}</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = users.map(user => `
        <tr>
            <td class="user-id">${user.id}</td>
            <td class="${user.first_name ? 'user-firstname' : 'cell-na'}">${user.first_name || '-'}</td>
            <td class="${user.last_name ? 'user-lastname' : 'cell-na'}">${user.last_name || '-'}</td>
            <td class="user-email">${user.email}</td>
            <td>
                ${user.roles.map(role => `
                    <span class="badge ${role === 'ADMIN' ? 'badge-primary' : 'badge-secondary'}">
                        ${role}
                    </span>
                `).join(' ')}
            </td>
            <td>
                <span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">
                    ${user.is_active ? 'Actif' : 'Bloque'}
                </span>
            </td>
            <td class="text-center">
                <i class="bi ${user.is_verified ? 'bi-check-circle-fill verified-yes' : 'bi-x-circle verified-no'} verified-icon"></i>
            </td>
            <td>
                <div class="actions-cell">
                    <button class="btn-action ${user.is_active ? 'btn-action-block' : 'btn-action-unblock'}"
                            onclick="toggleActive(${user.id})"
                            title="${user.is_active ? 'Bloquer' : 'Debloquer'}">
                        <i class="bi bi-${user.is_active ? 'lock' : 'unlock'}"></i>
                    </button>
                    <button class="btn-action btn-action-admin"
                            onclick="toggleAdmin(${user.id})"
                            title="${user.is_admin ? 'Retirer admin' : 'Promouvoir admin'}">
                        <i class="bi bi-shield${user.is_admin ? '-fill' : ''}"></i>
                    </button>
                    <button class="btn-action btn-action-password"
                            onclick="showResetPassword(${user.id})"
                            title="Reinitialiser mot de passe">
                        <i class="bi bi-key"></i>
                    </button>
                    <button class="btn-action btn-action-delete"
                            onclick="showDeleteConfirm(${user.id})"
                            title="Supprimer">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

async function toggleActive(userId) {
    try {
        const response = await fetch(`/api/admin/users/${userId}/toggle-active`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const data = await response.json();
            // Mettre a jour l'utilisateur localement
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                user.is_active = data.is_active;
            }
            categorizeAndRender();
            showToast(data.message, 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la modification', 'error');
    }
}

async function toggleAdmin(userId) {
    try {
        const response = await fetch(`/api/admin/users/${userId}/toggle-admin`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const data = await response.json();
            // Mettre a jour l'utilisateur localement
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                user.is_admin = data.is_admin;
                if (data.is_admin && !user.roles.includes('ADMIN')) {
                    user.roles.push('ADMIN');
                } else if (!data.is_admin) {
                    user.roles = user.roles.filter(r => r !== 'ADMIN');
                }
            }
            categorizeAndRender();
            showToast(data.message, 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la modification', 'error');
    }
}

function showResetPassword(userId) {
    currentUserId = userId;
    document.getElementById('resetTokenResult').style.display = 'none';
    document.getElementById('resetTokenInitial').style.display = 'block';
    document.getElementById('confirmResetBtn').style.display = '';
    openModal('resetPasswordModal');
}

document.getElementById('confirmResetBtn').addEventListener('click', async function() {
    try {
        const response = await fetch(`/api/admin/users/${currentUserId}/reset-password`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('resetTokenValue').textContent = data.reset_token;
            document.getElementById('resetTokenResult').style.display = 'block';
            document.getElementById('resetTokenInitial').style.display = 'none';
            document.getElementById('confirmResetBtn').style.display = 'none';
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la reinitialisation', 'error');
    }
});

function showDeleteConfirm(userId) {
    currentUserId = userId;
    openModal('deleteModal');
}

document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    try {
        const response = await fetch(`/api/admin/users/${currentUserId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        closeModal('deleteModal');

        if (response.ok) {
            // Supprimer l'utilisateur localement
            allUsers = allUsers.filter(u => u.id !== currentUserId);
            categorizeAndRender();
            showToast('Utilisateur supprime', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erreur', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Erreur lors de la suppression', 'error');
    }
});

// Charger les utilisateurs au chargement de la page
loadAllUsers();
</script>
{% endblock %}
